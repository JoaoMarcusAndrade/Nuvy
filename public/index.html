<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nuvy</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous" />
  <!-- Fonte personalizada -->
  <link href="https://fonts.googleapis.com/css2?family=Bagel+Fat+One&display=swap" rel="stylesheet" />
  <!-- CSS customizado unificado -->
  <link rel="stylesheet" href="css/style.css" />
  <link rel="manifest" href="manifest.json">
</head>

<body>
  <!-- Parte de cima do site com links (só aparece na home) -->
  <header id="main-header">
    <a href="#ajuda">Ajuda</a>
    <a href="#contato">Contato</a>
  </header>

  <!-- Área principal da página inicial -->
  <div id="home" class="container section active">
    <img src="img/NuvyPet.png" alt="Nuvem" class="cloud" draggable="false" />
    <div class="text-box">
      <h1 class="NuvyH1">Nuvy</h1>
      <p class="NuvyP">
        Nosso programa de ensino mistura o brincar com o aprendizado, visando
        sempre o conforto do nosso público.
      </p>
      <!-- Botão para abrir o modal de login/cadastro -->
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
        Acessar
      </button>
    </div>
  </div>

  <!-- Área de Jogos (inicialmente oculta) -->
  <div id="jogos-section" class="section">
    <!-- Navbar para área de jogos -->
    <nav class="navbar">
      <div class="navbar-left">
        <img src="img/NuvyPet.png" alt="Logo Nuvy" class="logo">
        <a href="#ajuda">Ajuda</a>
        <a href="#contato">Contato</a>
      </div>
      <div class="navbar-right">
        <img src="img/Login.png" width="55vh" alt="" style="margin-right: 30px;">
        <button id="logoutBtn" class="btn btn-outline-danger">Sair</button>
      </div>
    </nav>

    <!-- Conteúdo educativo -->
    <section class="educativo">
      <h2>Conteúdo educativo</h2>
      <div class="carrossel">
        <div class="card">
          <img src="img/Comp.jpg" alt="Vídeo educativo" class="videoscards">
        </div>
        <div class="card">
          <img src="img/Comp.jpg" alt="Vídeo educativo" class="videoscards">
        </div>
        <div class="card">
          <img src="img/Comp.jpg" alt="Vídeo educativo" class="videoscards">
        </div>
        <div class="card">
          <img src="img/Comp.jpg" alt="Vídeo educativo" class="videoscards">
        </div>
        <div class="card">
          <img src="img/Comp.jpg" alt="Vídeo educativo" class="videoscards">
        </div>
        <div class="card">
          <img src="img/Comp.jpg" alt="Vídeo educativo" class="videoscards">
        </div>
        <div class="card">
          <img src="img/Comp.jpg" alt="Vídeo educativo" class="videoscards">
        </div>
        <div class="card">
          <img src="img/Comp.jpg" alt="Vídeo educativo" class="videoscards">
        </div>
        <div class="card">
          <img src="img/Comp.jpg" alt="Vídeo educativo" class="videoscards">
        </div>
      </div>
      <div class="barra"></div>
    </section>

    <!-- Área do jogo -->
    <section class="jogo">
      <h2>Divirta-se e aprenda</h2>
      <div class="jogo-box">
        <img src="img/controle.png" alt="Controle" class="game-icon">
        <p>Aguarde enquanto carregamos o jogo...</p>
      </div>
    </section>

    <!-- Footer -->
    <footer>
      <p>© todos os direitos reservados - 2025</p>
    </footer>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content custom-modal">
        <div class="modal-header custom-modal-header">
          <button type="button" class="btn-close custom-btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <!-- LOGIN USUÁRIO -->
          <div id="loginView">
            <h2 class="text-center mb-4">Login</h2>
            <form id="formLogin">
              <input id="inpgmailLogin" type="email" placeholder="Digite seu E-mail." required />
              <input id="inpsenhaLogin" type="password" placeholder="Digite sua senha." required />
              <button type="submit" class="btn-login">Entrar</button>
            </form>
            <p class="signup-text">
              Não tem uma conta?
              <a href="#" id="toCadastro">cadastre-se</a>
            </p>
            <p id="avisoLogin" class="text"></p>
          </div>

          <!-- LOGIN RESPONSÁVEL -->
          <div id="loginResponsavelView" style="display: none;">
            <h2 class="text-center mb-4">Login Responsável</h2>
            <form id="formLoginResp">
              <input id="inpgmailLoginResp" type="email" placeholder="E-mail do Responsável." required />
              <input id="inpsenhaLoginResp" type="password" placeholder="Digite sua senha." required />
              <button type="submit" class="btn-login">Entrar</button>
            </form>
            <p class="signup-text">
              Não tem uma conta?
              <a href="#" id="toCadastroResp">cadastre-se</a>
            </p>
            <p id="avisoLoginResp" class="text"></p>
            <p id="avisoLoginResp" class="text"></p>
          </div>

          <!-- CADASTRO USUÁRIO -->
          <div id="cadastroView" style="display:none;">
            <h2 class="text-center mb-4">Cadastro</h2>
            <form id="formCadastro">
              <input id="inpnome" type="text" maxlength="40" placeholder="Digite seu Nome" />
              <input id="inpgmailCadastro" type="email" maxlength="100" placeholder="Digite seu E-mail." required />
              <input id="inpsenhaCadastro" type="password" maxlength="30" placeholder="Digite sua senha." required />
              <input id="inpconfirmsenha" type="password" maxlength="30" placeholder="Confirme sua senha." required />
              <input id="inpidade" type="number" min="1" max="120" placeholder="Digite sua idade" required />
              <button type="submit" class="btn-login">Cadastrar</button>
            </form>
            <p class="signup-text">
              Já tem uma conta?
              <a href="#" id="toLogin">voltar ao login</a>
            </p>
            <p id="avisoCadastro" class="text"></p>
          </div>

          <!-- CADASTRO RESPONSÁVEL -->
          <div id="cadastroResponsavelView" style="display: none;">
            <h2 class="text-center mb-4">Cadastro Responsável</h2>
            <form id="formCadastroResp">
              <input id="inpnomeResp" type="text" maxlength="40" placeholder="Nome do Responsável" />
              <input id="inpgmailCadastroResp" type="email" maxlength="100" placeholder="E-mail do Responsável."
                required />
              <input id="inpsenhaCadastroResp" type="password" maxlength="30" placeholder="Digite sua senha."
                required />
              <input id="inpconfirmsenhaResp" type="password" maxlength="30" placeholder="Confirme sua senha."
                required />
              <button type="submit" class="btn-login">Cadastrar</button>
            </form>
            <p class="signup-text">
              Já tem uma conta?
              <a href="#" id="toLoginResp">voltar ao login</a>
            </p>
            <p id="avisoCadastroResp" class="text"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <!-- PopperJS para Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    crossorigin="anonymous"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
  <script>
    // no início do seu script
    if (window.location.pathname === "/jogos") {
      // tentar mostrar jogos direto
      fetch("/check-auth", { credentials: "include" })
        .then(r => r.json())
        .then(data => {
          if (data.authenticated) {
            showJogosSection();
          } else {
            history.pushState({}, "", "/login");
            renderView("/login");
          }
        });
    }

    /* ---------- ELEMENTOS ---------- */
    // Elementos das views
    const loginView = document.getElementById("loginView");
    const loginRespView = document.getElementById("loginResponsavelView");
    const cadastroView = document.getElementById("cadastroView");
    const cadastroRespView = document.getElementById("cadastroResponsavelView");

    // Seções da SPA
    const homeSection = document.getElementById("home");
    const jogosSection = document.getElementById("jogos-section");
    const mainHeader = document.getElementById("main-header");

    // Botões de navegação entre login/cadastro
    const toCadastro = document.getElementById("toCadastro");
    const toLogin = document.getElementById("toLogin");

    // Botões de navegação do responsável
    const toCadastroResp = document.getElementById("toCadastroResp");
    const toLoginResp = document.getElementById("toLoginResp");

    // Elementos de aviso/erro
    const avisoLogin = document.getElementById("avisoLogin");
    const avisoLoginResp = document.getElementById("avisoLoginResp");
    const avisoCadastro = document.getElementById("avisoCadastro");
    const avisoCadastroResp = document.getElementById("avisoCadastroResp");

    // Variável para guardar ID do usuário recém cadastrado
    let usuarioRecemCadastradoID = null;

    /* ---------- FUNÇÕES DE VIEW ---------- */
    // Esconde todas as views do modal
    function hideAllViews() {
      loginView.style.display = "none";
      loginRespView.style.display = "none";
      cadastroView.style.display = "none";
      cadastroRespView.style.display = "none";
    }

    // Renderiza a view correta de acordo com o caminho
    function renderView(path) {
      hideAllViews();
      switch (path) {
        case "/login":
          loginView.style.display = "block"; break;
        case "/login/responsavel":
          loginRespView.style.display = "block"; break;
        case "/cadastro":
          cadastroView.style.display = "block"; break;
        case "/cadastro/responsavel":
          cadastroRespView.style.display = "block"; break;
        default:
          loginView.style.display = "block";
      }
    }

    // Mostra a seção de jogos e esconde a home
    function showJogosSection() {
      homeSection.classList.remove("active");
      homeSection.style.display = "none";
      mainHeader.style.display = "none";
      jogosSection.classList.add("active");
      jogosSection.style.display = "flex";

      history.pushState({}, "", "/jogos");
      // Forçar redimensionamento para corrigir layout
      setTimeout(() => { window.dispatchEvent(new Event('resize')); }, 50);
      window.scrollTo(0, 0);
    }

    // Mostra a seção home e esconde a de jogos
    function showHomeSection() {
      jogosSection.classList.remove("active");
      jogosSection.style.display = "none";
      homeSection.classList.add("active");
      homeSection.style.display = "flex";
      mainHeader.style.display = "block";
      window.scrollTo(0, 0);
    }

    // Fecha o modal
    function closeModal() {
      const modal = bootstrap.Modal.getInstance(document.getElementById('staticBackdrop'));
      modal.hide();
    }

    // Renderiza la view ao carregar a página e ao navegar pelo histórico
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        // verifica se há cookie válido no servidor
        const res = await fetch("/check-auth", { credentials: "include" });
        const data = await res.json();

        if (data.authenticated) {
          // já tem cookie válido → mostra a área de jogos
          closeModal(); // garante que modal esteja fechado
          showJogosSection();
        } else {
          // não autenticado → mostra login normal
          renderView(window.location.pathname);
        }
      } catch (err) {
        renderView("/login");
      }
    });

    // ---------- LOGOUT ----------
    document.addEventListener("DOMContentLoaded", () => {
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          // faz o logout no servidor e limpa cookies
          await fetch("/logout", { method: "POST", credentials: "include" });
          // volta para a tela inicial/login
          showHomeSection();
          history.pushState({}, "", "/login");
          renderView("/login");
        });
      }
    });

    window.addEventListener("popstate", () => renderView(window.location.pathname));

    /* ---------- NAVEGAÇÃO ---------- */
    // Troca para tela de cadastro
    toCadastro.onclick = e => { e.preventDefault(); history.pushState({}, "", "/cadastro"); renderView("/cadastro"); };
    // Troca para tela de login
    toLogin.onclick = e => { e.preventDefault(); history.pushState({}, "", "/login"); renderView("/login"); };

    /* ---------- NAVEGAÇÃO DO RESPONSÁVEL ---------- */
    // Troca para tela de cadastro do responsável
    toCadastroResp.onclick = e => {
      e.preventDefault();
      history.pushState({}, "", "/cadastro/responsavel");
      renderView("/cadastro/responsavel");
    };

    // Troca para tela de login do responsável
    toLoginResp.onclick = e => {
      e.preventDefault();
      history.pushState({}, "", "/login/responsavel");
      renderView("/login/responsavel");
    };

    /* ---------- CADASTRO USUÁRIO ---------- */
    // Lógica de cadastro de usuário
    document.getElementById("formCadastro").onsubmit = async e => {
      e.preventDefault();
      const email = document.getElementById("inpgmailCadastro").value;
      const senha = document.getElementById("inpsenhaCadastro").value;
      const nome = document.getElementById("inpnome").value;
      const idade = parseInt(document.getElementById("inpidade").value);
      const confirmaSenha = document.getElementById("inpconfirmsenha").value;

      // Validação de senha
      if (senha.length < 8) {
        avisoCadastro.style.color = "red";
        avisoCadastro.textContent = "Senha mínima 8 caracteres";
        return;
      }
      if (senha !== confirmaSenha) {
        avisoCadastro.style.color = "red";
        avisoCadastro.textContent = "As senhas não coincidem!";
        return;
      }

      // Envia dados para o backend
      try {
        const res = await fetch("/cadastro", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, senha, nome, idade }),
        });
        const data = await res.json();
        if (!res.ok) {
          avisoCadastro.style.color = "red";
          avisoCadastro.textContent = data.msg;
          return;
        }

        avisoCadastro.style.color = "green";
        avisoCadastro.textContent = "Usuário cadastrado com sucesso!";
        usuarioRecemCadastradoID = data.usuario.ID_usuarios;

        // Se for menor de idade, pede LOGIN do responsável (ALTERADO)
        if (idade < 16) {
          history.pushState({}, "", "/login/responsavel");
          renderView("/login/responsavel");
        } else {
          // Se for maior de idade, fecha o modal e mostra a área de jogos
          closeModal();
          showJogosSection();
        }
      } catch (err) {
        avisoCadastro.style.color = "red";
        avisoCadastro.textContent = "Erro ao cadastrar usuário";
      }
    };

    /* ---------- CADASTRO RESPONSÁVEL ---------- */
    // Lógica de cadastro do responsável
    document.getElementById("formCadastroResp").onsubmit = async e => {
      e.preventDefault();
      const email = document.getElementById("inpgmailCadastroResp").value;
      const senha = document.getElementById("inpsenhaCadastroResp").value;
      const nome = document.getElementById("inpnomeResp").value;
      const confirmaSenha = document.getElementById("inpconfirmsenhaResp").value;

      // Validação de senha
      if (senha.length < 8) {
        avisoCadastroResp.style.color = "red";
        avisoCadastroResp.textContent = "Senha mínima 8 caracteres";
        return;
      }
      if (senha !== confirmaSenha) {
        avisoCadastroResp.style.color = "red";
        avisoCadastroResp.textContent = "As senhas não coincidem!";
        return;
      }

      // Envia dados para o backend
      try {
        const res = await fetch("/cadastro/responsavel", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, senha, nome }),
        });
        const data = await res.json();
        if (!res.ok) {
          avisoCadastroResp.style.color = "red";
          avisoCadastroResp.textContent = data.msg;
          return;
        }

        avisoCadastroResp.style.color = "green";
        avisoCadastroResp.textContent = "Responsável cadastrado com sucesso!";

        // Cria vínculo entre usuário and responsável
        if (usuarioRecemCadastradoID) {
          const vinculoRes = await fetch("/vincular", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idUsuario: usuarioRecemCadastradoID, idResponsavel: data.responsavel.ID_responsaveis })
          });

          if (vinculoRes.ok) {
            avisoCadastroResp.style.color = "green";
            avisoCadastroResp.textContent += " Vínculo criado com sucesso!";

            // Fecha o modal e mostra a área de jogos
            setTimeout(() => {
              closeModal();
              showJogosSection();
            }, 1500);
          }
        }
      } catch (err) {
        avisoCadastroResp.style.color = "red";
        avisoCadastroResp.textContent = "Erro ao cadastrar responsável";
      }
    };

    /* ---------- LOGIN USUÁRIO ---------- */
    // Lógica de login do usuário
    document.getElementById("formLogin").onsubmit = async e => {
      e.preventDefault();
      const email = document.getElementById("inpgmailLogin").value;
      const senha = document.getElementById("inpsenhaLogin").value;

      // Envia dados para o backend
      try {
        const res = await fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, senha }),
        });
        const data = await res.json();
        if (res.ok) {
          avisoLogin.style.color = "green";
          avisoLogin.textContent = data.msg;

          // Fecha o modal e mostra a área de jogos
          closeModal();
          showJogosSection();
        } else {
          avisoLogin.style.color = "red";
          avisoLogin.textContent = data.msg;

          // Se o erro indicar que precisa de responsável, vai para o login do responsável (ALTERADO)
          if (data.requireResponsavel) {
            history.pushState({}, "", "/login/responsavel");
            renderView("/login/responsavel");
          }
        }
      } catch (err) {
        avisoLogin.style.color = "red";
        avisoLogin.textContent = "Erro ao conectar com servidor";
      }
    };

    /* ---------- LOGIN RESPONSÁVEL ---------- */
    // Lógica de login do responsável
    document.getElementById("formLoginResp").onsubmit = async e => {
      e.preventDefault();
      const email = document.getElementById("inpgmailLoginResp").value;
      const senha = document.getElementById("inpsenhaLoginResp").value;

      // Envia dados para o backend
      try {
        const res = await fetch("/login/responsavel", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, senha }),
        });
        const data = await res.json();
        if (res.ok) {
          avisoLoginResp.style.color = "green";
          avisoLoginResp.textContent = data.msg;

          // Fecha o modal e mostra a área de jogos
          closeModal();
          showJogosSection();
        } else {
          avisoLoginResp.style.color = "red";
          avisoLoginResp.textContent = data.msg;
        }
      } catch (err) {
        avisoLoginResp.style.color = "red";
        avisoLoginResp.textContent = "Erro ao conectar com servidor";
      }
    };
  </script>